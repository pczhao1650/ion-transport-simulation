<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦»å­ä¸»åŠ¨è¿è¾“æ¨¡æ‹Ÿå™¨ - Ion Transport Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .simulation-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .control-group h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .slider-container {
            margin-bottom: 10px;
        }

        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .value-display {
            text-align: center;
            font-weight: bold;
            color: #667eea;
            margin-top: 5px;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        #simulationCanvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            display: block;
            margin: 20px auto;
            background: linear-gradient(180deg, #e3f2fd 0%, #f3e5f5 100%);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        .graph-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .graph-container h3 {
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }

        #transportGraph {
            border: 2px solid #dee2e6;
            border-radius: 5px;
            background: white;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            #simulationCanvas {
                width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§¬ ç¦»å­ä¸»åŠ¨è¿è¾“æ¨¡æ‹Ÿå™¨</h1>
    </div>

    <div class="simulation-container">
        <div class="controls">
            <div class="control-group">
                <h3>è½¬è¿è›‹ç™½æ•°é‡</h3>
                <div class="slider-container">
                    <label>è†œä¸Šè½¬è¿è›‹ç™½æ•°é‡</label>
                    <input type="range" id="proteinCount" class="slider" min="0" max="10" value="3">
                    <div class="value-display" id="proteinValue">3</div>
                </div>
            </div>

            <div class="control-group">
                <h3>ç»†èƒèƒ½é‡æ°´å¹³</h3>
                <div class="slider-container">
                    <label>ATPæµ“åº¦ (mM)</label>
                    <input type="range" id="atpLevel" class="slider" min="0" max="10" value="5" step="0.1">
                    <div class="value-display" id="atpValue">5.0 mM</div>
                </div>
            </div>

            <div class="control-group">
                <h3>ç»†èƒå¤–ç¦»å­æµ“åº¦</h3>
                <div class="slider-container">
                    <label>Naâºæµ“åº¦ (mM)</label>
                    <input type="range" id="naConcentration" class="slider" min="0" max="200" value="100">
                    <div class="value-display" id="naValue">100 mM</div>
                </div>
            </div>

            <div class="control-group">
                <h3>æ§åˆ¶é¢æ¿</h3>
                <button id="startBtn">å¼€å§‹æ¨¡æ‹Ÿ</button>
                <button id="pauseBtn" disabled>æš‚åœ</button>
                <button id="resetBtn">é‡ç½®</button>
            </div>
        </div>

        <canvas id="simulationCanvas" width="800" height="400"></canvas>

        <div class="graph-container">
            <h3>è¿è¾“é€Ÿç‡å˜åŒ–å›¾</h3>
            <canvas id="transportGraph" width="760" height="200"></canvas>
        </div>
    </div>

    <script>
        class IonTransportSimulation {
            constructor() {
                this.canvas = document.getElementById('simulationCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.graphCanvas = document.getElementById('transportGraph');
                this.graphCtx = this.graphCanvas.getContext('2d');
                
                this.isRunning = false;
                this.frameCount = 0;
                this.transportRate = 0;
                this.intracellularIons = 0;
                this.energyConsumption = 0;
                this.efficiency = 0;
                
                this.ions = [];
                this.proteins = [];
                this.transportHistory = [];
                
                this.membraneX = 400; // ç»†èƒè†œä½ç½®
                this.membraneWidth = 40; // ç»†èƒè†œå®½åº¦
                
                this.initializeSimulation();
                this.setupEventListeners();
                this.draw();
                this.updateGraph(); // åˆå§‹ç»˜åˆ¶å›¾è¡¨
            }

            initializeSimulation() {
                // åˆå§‹åŒ–è½¬è¿è›‹ç™½ - åˆ†å¸ƒåœ¨ç»†èƒè†œä¸Š
                this.proteins = [];
                const proteinCount = parseInt(document.getElementById('proteinCount').value);
                
                // åœ¨ç»†èƒè†œä¸Šå‡åŒ€åˆ†å¸ƒè½¬è¿è›‹ç™½
                for (let i = 0; i < proteinCount; i++) {
                    const y = 50 + (i * (this.canvas.height - 100) / Math.max(1, proteinCount - 1));
                    this.proteins.push({
                        x: this.membraneX,
                        y: y,
                        active: false
                    });
                }

                // åˆå§‹åŒ–ç¦»å­
                this.ions = [];
                const naConcentration = parseInt(document.getElementById('naConcentration').value);
                
                // ç»†èƒå¤–ç¦»å­ï¼ˆä½æµ“åº¦ï¼‰
                for (let i = 0; i < naConcentration / 8; i++) { // ç»†èƒå¤–ç¦»å­æ•°é‡è¾ƒå°‘
                    this.ions.push({
                        x: Math.random() * (this.membraneX - 50) + 25,
                        y: Math.random() * this.canvas.height,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        transported: false,
                        color: '#FF6B6B'
                    });
                }

                // ç»†èƒå†…ç¦»å­ï¼ˆé«˜æµ“åº¦ï¼‰
                for (let i = 0; i < naConcentration / 3; i++) { // ç»†èƒå†…ç¦»å­æ•°é‡è¾ƒå¤š
                    this.ions.push({
                        x: this.membraneX + 50 + Math.random() * (this.canvas.width - this.membraneX - 100),
                        y: Math.random() * this.canvas.height,
                        vx: (Math.random() - 0.5) * 1,
                        vy: (Math.random() - 0.5) * 1,
                        transported: true, // æ ‡è®°ä¸ºç»†èƒå†…ç¦»å­
                        color: '#FF6B6B'
                    });
                }
            }

            setupEventListeners() {
                // æ»‘å—äº‹ä»¶
                document.getElementById('proteinCount').addEventListener('input', (e) => {
                    document.getElementById('proteinValue').textContent = e.target.value;
                    this.initializeSimulation();
                    this.updateGraph(); // å‚æ•°å˜åŒ–æ—¶æ›´æ–°å›¾è¡¨
                });

                document.getElementById('atpLevel').addEventListener('input', (e) => {
                    document.getElementById('atpValue').textContent = e.target.value + ' mM';
                    this.updateGraph(); // å‚æ•°å˜åŒ–æ—¶æ›´æ–°å›¾è¡¨
                });

                document.getElementById('naConcentration').addEventListener('input', (e) => {
                    document.getElementById('naValue').textContent = e.target.value + ' mM';
                    this.initializeSimulation();
                    this.updateGraph(); // å‚æ•°å˜åŒ–æ—¶æ›´æ–°å›¾è¡¨
                });

                // æŒ‰é’®äº‹ä»¶
                document.getElementById('startBtn').addEventListener('click', () => this.start());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pause());
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
            }

            start() {
                this.isRunning = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                this.gameLoop();
            }

            pause() {
                this.isRunning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
            }

            reset() {
                this.pause();
                this.frameCount = 0;
                this.transportRate = 0;
                this.intracellularIons = 0;
                this.energyConsumption = 0;
                this.efficiency = 0;
                this.transportHistory = [];
                this.initializeSimulation();
                this.draw();
                this.updateGraph();
            }

            gameLoop() {
                if (!this.isRunning) return;

                this.update();
                this.draw();
                this.frameCount++;

                requestAnimationFrame(() => this.gameLoop());
            }

            // è®¡ç®—è¿è¾“é€Ÿç‡ï¼ˆåŸºäºä¸‰ä¸ªå‚æ•°çš„é¥±å’Œå‡½æ•°ï¼‰
            calculateTransportRate() {
                const proteinCount = parseInt(document.getElementById('proteinCount').value);
                const atpLevel = parseFloat(document.getElementById('atpLevel').value);
                const naConcentration = parseInt(document.getElementById('naConcentration').value);

                // è½¬è¿è›‹ç™½é¥±å’Œå‡½æ•°ï¼šVmax * (n / (n + K1))
                const proteinFactor = (proteinCount / (proteinCount + 2)); // K1 = 2

                // ATPé¥±å’Œå‡½æ•°ï¼šVmax * (ATP / (ATP + K2))
                const atpFactor = (atpLevel / (atpLevel + 3)); // K2 = 3

                // ç¦»å­æµ“åº¦é¥±å’Œå‡½æ•°ï¼šVmax * (C / (C + K3))
                const concentrationFactor = (naConcentration / (naConcentration + 50)); // K3 = 50

                // ç»¼åˆè¿è¾“é€Ÿç‡ = åŸºç¡€é€Ÿç‡ * ä¸‰ä¸ªå› å­çš„ä¹˜ç§¯
                const baseRate = 10; // åŸºç¡€è¿è¾“é€Ÿç‡
                const transportRate = baseRate * proteinFactor * atpFactor * concentrationFactor;

                return transportRate;
            }

            update() {
                // æ›´æ–°ç¦»å­ä½ç½®
                this.ions.forEach(ion => {
                    if (!ion.transported) {
                        // ç»†èƒå¤–ç¦»å­å¯ä»¥ç§»åŠ¨
                        ion.x += ion.vx;
                        ion.y += ion.vy;

                        // è¾¹ç•Œæ£€æµ‹ - ä¸èƒ½ç©¿è¿‡ç»†èƒè†œ
                        if (ion.x < 0 || ion.x > this.membraneX - 25) ion.vx *= -1;
                        if (ion.y < 0 || ion.y > this.canvas.height) ion.vy *= -1;

                        // ä¿æŒåœ¨è¾¹ç•Œå†…
                        ion.x = Math.max(0, Math.min(this.membraneX - 25, ion.x));
                        ion.y = Math.max(0, Math.min(this.canvas.height, ion.y));
                    } else {
                        // ç»†èƒå†…ç¦»å­ä¹Ÿå¯ä»¥è½»å¾®ç§»åŠ¨
                        ion.x += ion.vx * 0.3;
                        ion.y += ion.vy * 0.3;

                        // è¾¹ç•Œæ£€æµ‹ - ä¸èƒ½ç¦»å¼€ç»†èƒå†…åŒºåŸŸ
                        if (ion.x < this.membraneX + 50 || ion.x > this.canvas.width - 25) ion.vx *= -1;
                        if (ion.y < 0 || ion.y > this.canvas.height) ion.vy *= -1;

                        // ä¿æŒåœ¨è¾¹ç•Œå†…
                        ion.x = Math.max(this.membraneX + 50, Math.min(this.canvas.width - 25, ion.x));
                        ion.y = Math.max(0, Math.min(this.canvas.height, ion.y));
                    }
                });

                // æ£€æŸ¥ç»†èƒå¤–ç¦»å­ä¸è½¬è¿è›‹ç™½çš„ç›¸äº’ä½œç”¨
                this.proteins.forEach(protein => {
                    protein.active = false;

                    this.ions.forEach(ion => {
                        if (!ion.transported) { // åªå¤„ç†ç»†èƒå¤–ç¦»å­
                            const distance = Math.sqrt(
                                Math.pow(ion.x - protein.x, 2) + 
                                Math.pow(ion.y - protein.y, 2)
                            );

                            if (distance < 30) {
                                protein.active = true;

                                // è¿è¾“æ¦‚ç‡åŸºäºATPæµ“åº¦
                                const atpLevel = parseFloat(document.getElementById('atpLevel').value);
                                const transportProbability = (atpLevel / 10) * 0.05; // æé«˜è¿è¾“æ¦‚ç‡

                                if (Math.random() < transportProbability) {
                                    // æ ‡è®°ä¸ºå·²è¿è¾“
                                    ion.transported = true;
                                    // ç§»åŠ¨åˆ°ç»†èƒå†…ä½ç½®
                                    ion.x = protein.x + 50;
                                    ion.y = protein.y;
                                    // è®¾ç½®ç»†èƒå†…è¿åŠ¨é€Ÿåº¦
                                    ion.vx = (Math.random() - 0.5) * 1;
                                    ion.vy = (Math.random() - 0.5) * 1;
                                    this.intracellularIons++;
                                    this.energyConsumption += 1;
                                }
                            }
                        }
                    });
                });

                // è®¡ç®—è¿è¾“é€Ÿç‡ï¼ˆåŸºäºå‚æ•°ï¼Œä¸è€ƒè™‘éšæœºè¿åŠ¨ï¼‰
                this.transportRate = this.calculateTransportRate();
            }

            drawPhospholipidBilayer() {
                const ctx = this.ctx;
                const x = this.membraneX;
                const width = this.membraneWidth;
                const height = this.canvas.height;

                // ç»˜åˆ¶ç£·è„‚åŒåˆ†å­å±‚
                ctx.save();
                
                // å¤–å±‚ç£·è„‚å¤´éƒ¨ï¼ˆå·¦ä¾§ï¼‰
                ctx.fillStyle = '#B0B0B0';
                ctx.fillRect(x - width/2, 0, width/4, height);
                
                // å†…å±‚ç£·è„‚å¤´éƒ¨ï¼ˆå³ä¾§ï¼‰
                ctx.fillStyle = '#B0B0B0';
                ctx.fillRect(x + width/4, 0, width/4, height);
                
                // ç£·è„‚å°¾éƒ¨ï¼ˆé»„è‰²æ³¢æµªçŠ¶ï¼‰
                ctx.fillStyle = '#FFD700';
                
                // å·¦ä¾§å°¾éƒ¨
                ctx.beginPath();
                for (let y = 0; y < height; y += 10) {
                    const wave = Math.sin(y * 0.1) * 3;
                    ctx.lineTo(x - width/4 + wave, y);
                }
                ctx.lineTo(x - width/4, height);
                ctx.lineTo(x - width/2, height);
                ctx.lineTo(x - width/2, 0);
                ctx.closePath();
                ctx.fill();
                
                // å³ä¾§å°¾éƒ¨
                ctx.beginPath();
                for (let y = 0; y < height; y += 10) {
                    const wave = Math.sin(y * 0.1) * 3;
                    ctx.lineTo(x + width/2 - wave, y);
                }
                ctx.lineTo(x + width/2, height);
                ctx.lineTo(x + width/4, height);
                ctx.lineTo(x + width/4, 0);
                ctx.closePath();
                ctx.fill();
                
                // ç»˜åˆ¶ç£·è„‚å¤´éƒ¨ç»†èŠ‚
                ctx.fillStyle = '#A0A0A0';
                for (let y = 0; y < height; y += 15) {
                    // å·¦ä¾§å¤´éƒ¨
                    ctx.beginPath();
                    ctx.ellipse(x - width/2 + width/8, y, width/8, 6, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // å³ä¾§å¤´éƒ¨
                    ctx.beginPath();
                    ctx.ellipse(x + width/2 - width/8, y, width/8, 6, 0, 0, 2 * Math.PI);
                    ctx.fill();
                }
                
                ctx.restore();
            }

            draw() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // ç»˜åˆ¶ç£·è„‚åŒåˆ†å­å±‚
                this.drawPhospholipidBilayer();

                // ç»˜åˆ¶è½¬è¿è›‹ç™½ï¼ˆç´«è‰²åœ†çƒï¼Œæ¯”ç»†èƒè†œå®½ï¼‰
                this.proteins.forEach(protein => {
                    this.ctx.save();
                    this.ctx.translate(protein.x, protein.y);
                    
                    // è½¬è¿è›‹ç™½ä¸»ä½“ï¼ˆç´«è‰²åœ†çƒï¼‰
                    this.ctx.fillStyle = protein.active ? '#9C27B0' : '#7B1FA2';
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, 25, 0, 2 * Math.PI);
                    this.ctx.fill();
                    
                    // è½¬è¿è›‹ç™½è¾¹æ¡†
                    this.ctx.strokeStyle = '#4A148C';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                    
                    this.ctx.restore();
                });

                // ç»˜åˆ¶æ‰€æœ‰ç¦»å­
                this.ions.forEach(ion => {
                    this.ctx.fillStyle = ion.color; // å§‹ç»ˆä½¿ç”¨çº¢è‰²
                    this.ctx.beginPath();
                    this.ctx.arc(ion.x, ion.y, 6, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#333';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                });

                // ç»˜åˆ¶ATPåˆ†å­
                const atpLevel = parseFloat(document.getElementById('atpLevel').value);
                for (let i = 0; i < atpLevel * 2; i++) {
                    this.ctx.fillStyle = '#FFD700';
                    this.ctx.beginPath();
                    this.ctx.arc(450 + (i % 10) * 20, 50 + Math.floor(i / 10) * 20, 4, 0, Math.PI * 2);
                    this.ctx.fill();
                }

                // ç»˜åˆ¶åŒºåŸŸæ ‡ç­¾
                this.ctx.fillStyle = '#666';
                this.ctx.font = '16px Arial';
                this.ctx.fillText('ç»†èƒå¤–', 50, 30);
                this.ctx.fillText('ç»†èƒå†…', 450, 30);
            }

            updateGraph() {
                // è®¡ç®—å½“å‰è¿è¾“é€Ÿç‡
                const currentRate = this.calculateTransportRate();
                
                // æ·»åŠ åˆ°å†å²è®°å½•
                this.transportHistory.push({
                    time: this.frameCount / 60,
                    rate: currentRate
                });

                // ä¿æŒæœ€è¿‘100ä¸ªæ•°æ®ç‚¹
                if (this.transportHistory.length > 100) {
                    this.transportHistory.shift();
                }

                this.drawGraph();
            }

            drawGraph() {
                const ctx = this.graphCtx;
                const canvas = this.graphCanvas;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (this.transportHistory.length < 2) return;

                // ç»˜åˆ¶åæ ‡è½´
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(50, 20);
                ctx.lineTo(50, canvas.height - 20);
                ctx.lineTo(canvas.width - 20, canvas.height - 20);
                ctx.stroke();

                // ç»˜åˆ¶æ ‡ç­¾
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.fillText('è¿è¾“é€Ÿç‡', 10, 15);
                ctx.fillText('æ—¶é—´ (ç§’)', canvas.width - 60, canvas.height - 5);

                // ç»˜åˆ¶æ•°æ®çº¿
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();

                const maxRate = Math.max(...this.transportHistory.map(d => d.rate));
                const maxTime = Math.max(...this.transportHistory.map(d => d.time));

                this.transportHistory.forEach((point, index) => {
                    const x = 50 + (point.time / maxTime) * (canvas.width - 70);
                    const y = canvas.height - 20 - (point.rate / maxRate) * (canvas.height - 40);

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();

                // æ˜¾ç¤ºå½“å‰è¿è¾“é€Ÿç‡å€¼
                ctx.fillStyle = '#667eea';
                ctx.font = '14px Arial';
                ctx.fillText(`å½“å‰è¿è¾“é€Ÿç‡: ${this.transportHistory[this.transportHistory.length - 1].rate.toFixed(2)}`, 10, canvas.height - 5);
            }
        }

        // åˆå§‹åŒ–æ¨¡æ‹Ÿå™¨
        const simulation = new IonTransportSimulation();
    </script>
</body>
</html>
